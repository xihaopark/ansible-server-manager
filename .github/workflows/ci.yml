name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', 3.11]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Lint with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test import modules
      run: |
        python -c "import streamlit; print('âœ… Streamlit import successful')"
        python -c "import ansible_runner; print('âœ… Ansible-runner import successful')"
        python -c "import pandas; print('âœ… Pandas import successful')"
        python -c "import yaml; print('âœ… PyYAML import successful')"

    - name: Test app syntax
      run: |
        python -m py_compile app_secure.py
        python -m py_compile app.py
        echo "âœ… All Python files compiled successfully"

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Run security scan with bandit
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . || true

    - name: Check for known vulnerabilities
      run: |
        pip install -r requirements.txt
        safety check || true

  build-docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mkdocs mkdocs-material

    - name: Create documentation structure
      run: |
        mkdir -p docs
        cat > docs/index.md << 'EOL'
        # Ansible æœåŠ¡å™¨ç®¡ç†å·¥å…·

        æ¬¢è¿Žä½¿ç”¨åŸºäºŽ Streamlit å’Œ Ansible çš„æœåŠ¡å™¨ç®¡ç†å¯è§†åŒ–å·¥å…·ï¼

        ## å¿«é€Ÿå¼€å§‹

        ### å®‰è£…
        ```bash
        git clone https://github.com/xihaopark/ansible-server-manager.git
        cd ansible-server-manager
        chmod +x setup.sh
        ./setup.sh
        ```

        ### è¿è¡Œ
        ```bash
        ./run.sh
        ```

        ## åŠŸèƒ½ç‰¹ç‚¹

        - ðŸ–¥ï¸ **æœåŠ¡å™¨çŠ¶æ€ç›‘æŽ§**ï¼šå®žæ—¶æ£€æŸ¥æœåŠ¡å™¨è¿žæŽ¥çŠ¶æ€
        - ðŸ”§ **è¿œç¨‹å‘½ä»¤æ‰§è¡Œ**ï¼šåœ¨é€‰å®šçš„æœåŠ¡å™¨ä¸Šæ‰§è¡ŒShellå‘½ä»¤
        - ðŸ“‹ **ç³»ç»Ÿä¿¡æ¯æ”¶é›†**ï¼šèŽ·å–æœåŠ¡å™¨çš„è¯¦ç»†ç³»ç»Ÿä¿¡æ¯
        - ðŸ“ˆ **èµ„æºç›‘æŽ§**ï¼šç›‘æŽ§CPUã€å†…å­˜ã€ç£ç›˜ç­‰èµ„æºä½¿ç”¨æƒ…å†µ
        - ðŸ“¦ **è½¯ä»¶åŒ…ç®¡ç†**ï¼šå®‰è£…ã€æ›´æ–°ã€åˆ é™¤è½¯ä»¶åŒ…
        - ðŸ”§ **æœåŠ¡ç®¡ç†**ï¼šå¯åŠ¨ã€åœæ­¢ã€é‡å¯ç³»ç»ŸæœåŠ¡
        - ðŸ“„ **æ—¥å¿—æŸ¥çœ‹**ï¼šæŸ¥çœ‹ç³»ç»Ÿå’Œåº”ç”¨æ—¥å¿—

        ## æˆªå›¾

        ![ä¸»ç•Œé¢](images/main-interface.png)
        ![ç›‘æŽ§é¢æ¿](images/monitoring-panel.png)

        EOL

        cat > mkdocs.yml << 'EOL'
        site_name: Ansible Server Manager
        site_description: åŸºäºŽStreamlitå’ŒAnsibleçš„æœåŠ¡å™¨ç®¡ç†å¯è§†åŒ–å·¥å…·
        site_author: xihao park
        site_url: https://xihaopark.github.io/ansible-server-manager/

        theme:
          name: material
          palette:
            primary: blue
            accent: light blue

        nav:
          - é¦–é¡µ: index.md

        markdown_extensions:
          - codehilite
          - admonition
        EOL

    - name: Build documentation
      run: mkdocs build

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site 